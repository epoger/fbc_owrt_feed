# FBWIFI

# Log to both klogd (so it will show up on serial port and "dmesg")
# and syslogd (so it will show up on "logread -e fbwifi")
log()
{
	echo "fbwifi-device: $*" >/dev/kmsg
	logger -t fbwifi-device "$*"
}

# Attempts to download a script from URL $1 into destfile $2.
# Returns 0 if the script download seems to have worked, 1 otherwise.
# We check not only that wget succeeded, but also that the downloaded file
# contains "FBWIFI" (indicating that it is not a boilerplate server response).
load_script()
{
	log "load_script $1"

	if [ "$1" == "" ]
	then
		return 1
	fi

	if ! wget -O $2 $1
	then
		return 1
	fi

	if grep -q FBWIFI $2
	then
		return 0
	else {
		log "Script is missing FBWIFI" ;
		return 1 ;
	}
	fi
}


case $(fw_printenv -n fbbranch) in
canary)
	RELEASE_BRANCH=canary
	RELEASE_TAG=20211203a
	;;
beta)
	RELEASE_BRANCH=beta
	RELEASE_TAG=20211203a
	;;
*)
	RELEASE_BRANCH=stable
	RELEASE_TAG=20211203a
	;;
esac
RELEASE_TAG_BASE_URL="https://raw.githubusercontent.com/epoger/fbc_owrt_feed/${RELEASE_TAG}/fbwifi-device-boot"

log "RELEASE_BRANCH=${RELEASE_BRANCH}"
log "RELEASE_TAG=${RELEASE_TAG}"
log "RELEASE_TAG_BASE_URL=${RELEASE_TAG_BASE_URL}"
echo ${RELEASE_BRANCH} >/etc/fbwifi-device/releasebranch
echo ${RELEASE_TAG} >/etc/fbwifi-device/releasetag
echo ${RELEASE_TAG_BASE_URL} >/etc/fbwifi-device/releasetagbaseurl

BOOTSCRIPT3_URL="${RELEASE_TAG_BASE_URL}/scripts/bootscript3"
BOOTSCRIPT3_PATH=/tmp/bootscript3
log "BOOTSCRIPT3_URL=${BOOTSCRIPT3_URL}"

while true; do
	rm -f "$BOOTSCRIPT3_PATH"
	if load_script "$BOOTSCRIPT3_URL" "$BOOTSCRIPT3_PATH"
	then {
		source $BOOTSCRIPT3_PATH
		exit
	}
	else {
		log "unable to download ${BOOTSCRIPT3_URL}"
	}
	fi
	sleep 30   # keep retrying until the reboot gets us
done
